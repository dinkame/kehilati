<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×—×•×’×™× ×•×¤×¢×™×œ×•×™×•×ª - ××¢×•×– ××‘×™×‘, ×”×“×¨ ×™×•×¡×£ ×•×”×¡×‘×™×‘×”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #059669; }
        .contact-button { transition: all 0.2s ease; }
        .contact-button:hover { transform: translateY(-1px); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto mb-4"></div>
            <div class="text-emerald-600 font-medium">×˜×•×¢×Ÿ ×—×•×’×™×...</div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-emerald-600 text-white py-8 shadow-lg">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-2">
                ×œ×•×— ×—×•×’×™× ×•×¤×¢×™×œ×•×™×•×ª
            </h1>
            <p class="text-center text-emerald-100 text-lg">
                ××¢×•×– ××‘×™×‘, ×”×“×¨ ×™×•×¡×£ ×•×”×¡×‘×™×‘×”
            </p>
            <p class="text-center text-emerald-200 mt-2">
                ××¦××• ××ª ×”×¤×¢×™×œ×•×ª ×”××•×©×œ××ª ×œ×™×œ×“×™×, × ×•×¢×¨ ×•××‘×•×’×¨×™×
            </p>
        </div>
    </header>

    <!-- Alert Banner -->
    <div class="bg-yellow-100 border-r-4 border-yellow-500 p-4">
        <div class="container mx-auto px-4">
            <div class="flex">
                <div class="mr-3">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div>
                    <p class="text-yellow-700 font-medium">×©×™××• ×œ×‘, ×”××¤×œ×™×§×¦×™×” ×¢×“×™×™×Ÿ ×‘×”×¨×¦×”!</p>
                    <p class="text-yellow-600 text-sm mt-1">
                        ×—×¡×¨ ×œ× ×• ××™×“×¢ ×¢×œ ×—×•×’×™× ××”××§×•××•×ª ×”×‘××™×:
                         â€¢ ×”××¨×›×– ×”××•×œ×™××¤×™ (××™×“×¢ ×—×œ×§×™) â€¢ ×‘×™×ª ×¡×¤×¨ ×’×™×œ (××™×“×¢ ×—×œ×§×™)
                    </p>
                    <p class="text-yellow-600 text-sm mt-1">
                        ××¦××ª×Ÿ ××©×”×• ×©×’×•×™ ××• ×—×¡×¨? 
                        × ×©××— ×× ×ª×©×œ×—×• ×”×•×“×¢×” ×œ×“×™× ×”
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <!-- Mobile Filter Toggle -->
            <button id="mobile-filter-toggle" class="md:hidden w-full mb-4 bg-emerald-600 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v4.586a1 1 0 01-.293.707L9 20.414a1 1 0 01-.707.293H8a1 1 0 01-1-1v-5.586a1 1 0 00-.293-.707L.293 7.707A1 1 0 010 7V4z" />
                </svg>
                ×¡×™× ×•×Ÿ ×—×•×’×™×
            </button>

            <!-- Filter Container -->
            <div id="filter-container" class="hidden md:grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- Neighborhood Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">×©×›×•× ×”</label>
                    <select id="neighborhood-filter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">×›×œ ×”×©×›×•× ×•×ª</option>
                    </select>
                </div>

                <!-- Center Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">××¨×›×–</label>
                    <select id="center-filter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">×›×œ ×”××¨×›×–×™×</option>
                    </select>
                </div>

                <!-- Category Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">×§×˜×’×•×¨×™×”</label>
                    <select id="category-filter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
                    </select>
                </div>

                <!-- Age Group Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">×§×‘×•×¦×ª ×’×™×œ</label>
                    <select id="age-group-filter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">×›×œ ×”×’×™×œ××™×</option>
                    </select>
                </div>

                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">×—×™×¤×•×©</label>
                    <input type="text" id="search-input" placeholder="×—×¤×© ×—×•×’ ××• ××“×¨×™×š..." 
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Results Count -->
        <div id="results-count" class="mb-4 text-gray-600 font-medium"></div>

        <!-- Activities Grid -->
        <div id="activities-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Activities will be populated here -->
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="hidden text-center py-12">
            <div class="text-gray-400 text-6xl mb-4">ğŸ”</div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">×œ× × ××¦××• ×—×•×’×™× ××ª××™××™×</h3>
            <p class="text-gray-500">××¤×©×¨ ×œ× ×¡×•×ª ×œ×©× ×•×ª ××ª ××¤×©×¨×•×™×•×ª ×”×¡×™× ×•×Ÿ</p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden text-center py-12">
            <div class="text-red-400 text-6xl mb-4">âš ï¸</div>
            <h3 class="text-xl font-semibold text-red-600 mb-2">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</h3>
            <p class="text-red-500 mb-4">×× × × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£</p>
            <button onclick="location.reload()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                ×¨×¢× ×Ÿ ×“×£
            </button>
        </div>
    </main>

    <script>
        // Supabase Configuration - CORRECTED
        const SUPABASE_URL = 'https://unwmtxtwfnljnvqjzfig.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVud210eHR3Zm5sam52cWp6ZmlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDYyNjMsImV4cCI6MjA3MTYyMjI2M30.wSslNvSl_T2qpG5lxi66-o38XaExHaIaJFlv6d4QwiA'
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // Global variables
        let allActivities = []
        let neighborhoods = []
        let centers = []
        let categories = []
        let ageGroups = []

        // Day names mapping
        const dayNames = {
            1: '×¨××©×•×Ÿ',
            2: '×©× ×™', 
            3: '×©×œ×™×©×™',
            4: '×¨×‘×™×¢×™',
            5: '×—××™×©×™',
            6: '×©×™×©×™',
            7: '×©×‘×ª'
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM loaded, starting app...')
            
            try {
                await loadData()
                setupEventListeners()
                hideLoading()
            } catch (error) {
                console.error('Failed to initialize app:', error)
                showError()
            }
        })

        async function loadData() {
            console.log('Loading data from Supabase...')
            
            try {
                // Load filter data
                await Promise.all([
                    loadNeighborhoods(),
                    loadCenters(), 
                    loadCategories(),
                    loadAgeGroups()
                ])

                // Load activities
                await loadActivities()
                
                console.log('All data loaded successfully')
            } catch (error) {
                console.error('Error loading data:', error)
                throw error
            }
        }

        async function loadNeighborhoods() {
            console.log('Loading neighborhoods...')
            const { data, error } = await supabase
                .from('neighborhoods')
                .select('*')
                .order('name')

            if (error) {
                console.error('Error loading neighborhoods:', error)
                throw error
            }

            neighborhoods = data || []
            populateNeighborhoodFilter()
            console.log(`Loaded ${neighborhoods.length} neighborhoods`)
        }

        async function loadCenters() {
            console.log('Loading centers...')
            const { data, error } = await supabase
                .from('centers')
                .select('*, neighborhoods(name)')
                .order('name')

            if (error) {
                console.error('Error loading centers:', error)
                throw error
            }

            centers = data || []
            populateCenterFilter()
            console.log(`Loaded ${centers.length} centers`)
        }

        async function loadCategories() {
            console.log('Loading categories...')
            const { data, error } = await supabase
                .from('categories')
                .select('*')
                .order('name')

            if (error) {
                console.error('Error loading categories:', error)
                throw error
            }

            categories = data || []
            populateCategoryFilter()
            console.log(`Loaded ${categories.length} categories`)
        }

        async function loadAgeGroups() {
            console.log('Loading age groups...')
            const { data, error } = await supabase
                .from('age_groups')
                .select('*')
                .order('id')

            if (error) {
                console.error('Error loading age groups:', error)
                throw error
            }

            ageGroups = data || []
            populateAgeGroupFilter()
            console.log(`Loaded ${ageGroups.length} age groups`)
        }

        async function loadActivities() {
            console.log('Loading activities from class_schedule_view...')
            const { data, error } = await supabase
                .from('class_schedule_view')
                .select('*')
                .eq('instance_active', true)
                .eq('template_active', true)

            if (error) {
                console.error('Error loading activities:', error)
                throw error
            }

            allActivities = data || []
            console.log(`Loaded ${allActivities.length} activities`)
            
            // Group activities by template
            const groupedActivities = groupActivitiesByTemplate(allActivities)
            displayActivities(groupedActivities)
            updateResultsCount(groupedActivities.length)
        }

        function groupActivitiesByTemplate(activities) {
            const grouped = {}
            
            activities.forEach(activity => {
                const templateId = activity.template_id
                if (!grouped[templateId]) {
                    grouped[templateId] = {
                        template: activity,
                        instances: []
                    }
                }
                grouped[templateId].instances.push(activity)
            })
            
            return Object.values(grouped)
        }

        function populateNeighborhoodFilter() {
            const select = document.getElementById('neighborhood-filter')
            if (!select) return
            
            select.innerHTML = '<option value="">×›×œ ×”×©×›×•× ×•×ª</option>'
            neighborhoods.forEach(neighborhood => {
                const option = document.createElement('option')
                option.value = neighborhood.id
                option.textContent = neighborhood.name
                select.appendChild(option)
            })
        }

        function populateCenterFilter() {
            const select = document.getElementById('center-filter')
            if (!select) return
            
            select.innerHTML = '<option value="">×›×œ ×”××¨×›×–×™×</option>'
            centers.forEach(center => {
                const option = document.createElement('option')
                option.value = center.id
                option.textContent = center.name
                select.appendChild(option)
            })
        }

        function populateCategoryFilter() {
            const select = document.getElementById('category-filter')
            if (!select) return
            
            select.innerHTML = '<option value="">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>'
            categories.forEach(category => {
                const option = document.createElement('option')
                option.value = category.id
                option.textContent = category.name
                select.appendChild(option)
            })
        }

        function populateAgeGroupFilter() {
            const select = document.getElementById('age-group-filter')
            if (!select) return
            
            select.innerHTML = '<option value="">×›×œ ×”×’×™×œ××™×</option>'
            ageGroups.forEach(ageGroup => {
                const option = document.createElement('option')
                option.value = ageGroup.id
                option.textContent = ageGroup.label
                select.appendChild(option)
            })
        }

        function displayActivities(groupedActivities) {
            const grid = document.getElementById('activities-grid')
            const noResults = document.getElementById('no-results')
            
            if (!grid) return
            
            if (groupedActivities.length === 0) {
                grid.style.display = 'none'
                if (noResults) noResults.classList.remove('hidden')
                return
            }
            
            grid.style.display = 'grid'
            if (noResults) noResults.classList.add('hidden')
            
            grid.innerHTML = groupedActivities.map(group => createActivityCard(group)).join('')
        }

        function createActivityCard(group) {
            const template = group.template
            const instances = group.instances
            
            // Get age display
            const ageDisplay = getAgeDisplay(template, instances)
            
            // Get schedule display
            const scheduleDisplay = getScheduleDisplay(instances)
            
            // Get contact info
            const contactInfo = getContactInfo(instances)
            
            return `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-xl font-semibold text-gray-900 leading-tight">
                                ${template.class_name || '×œ×œ× ×©×'}
                            </h3>
                            <span class="bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                                ${template.category_name || '×›×œ×œ×™'}
                            </span>
                        </div>
                        
                        ${template.description ? `<p class="text-gray-600 mb-4">${template.description}</p>` : ''}
                        
                        <div class="space-y-3">
                            <div class="flex items-center text-gray-700">
                                <svg class="h-5 w-5 text-emerald-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span>${template.center_name || '×œ×œ× ××™×§×•×'}</span>
                            </div>
                            
                            <div class="flex items-center text-gray-700">
                                <svg class="h-5 w-5 text-emerald-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <span>${ageDisplay}</span>
                            </div>
                            
                            <div class="flex items-start text-gray-700">
                                <svg class="h-5 w-5 text-emerald-600 ml-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="flex-1">
                                    ${scheduleDisplay}
                                </div>
                            </div>
                            
                            ${contactInfo}
                        </div>
                    </div>
                </div>
            `
        }

        function getAgeDisplay(template, instances) {
            // Collect all unique age information from instances
            const ageInfo = new Set()
            
            instances.forEach(instance => {
                // Check for age group in metadata
                if (instance.metadata?.age_group) {
                    ageInfo.add(instance.metadata.age_group)
                }
                // Check for specific age range in instance
                else if (instance.age_min !== null && instance.age_max !== null) {
                    ageInfo.add(`×’×™×œ××™ ${instance.age_min}-${instance.age_max}`)
                }
            })
            
            // If we found specific age info from instances, use it
            if (ageInfo.size > 0) {
                return Array.from(ageInfo).join(', ')
            }
            
            // Fallback to template information
            if (template.age_min !== null && template.age_max !== null) {
                return `×’×™×œ××™ ${template.age_min}-${template.age_max}`
            }
            
            // Final fallback to age group label
            if (template.age_group_label) {
                return template.age_group_label
            }
            
            return '×›×œ ×”×’×™×œ××™×'
        }

        function getScheduleDisplay(instances) {
            const schedules = instances.map(instance => {
                const day = dayNames[instance.day_of_week] || '×œ× ×¦×•×™×Ÿ'
                const startTime = instance.start_time ? instance.start_time.substring(0, 5) : ''
                const endTime = instance.end_time ? instance.end_time.substring(0, 5) : ''
                
                let timeStr = ''
                if (startTime && endTime) {
                    timeStr = ` ${startTime}-${endTime}`
                } else if (startTime) {
                    timeStr = ` ${startTime}`
                }
                
                return `${day}${timeStr}`
            })
            
            return schedules.join('<br>')
        }

        function getContactInfo(instances) {
            // Get contact info from all instances (might have different contact details)
            const firstInstance = instances[0] || {}
            
            const instructorName = firstInstance.instructor_name
            const centerPhone = firstInstance.center_phone
            const centerEmail = firstInstance.center_email
            const instructorPhone = firstInstance.instructor_phone
            const instructorEmail = firstInstance.instructor_email
            const centerWebsite = firstInstance.center_website
            const instructorWebsite = firstInstance.instructor_website
            
            let contactHtml = '<div class="mt-4 pt-4 border-t border-gray-200">'
            
            // Instructor info section
            if (instructorName) {
                contactHtml += `
                    <div class="text-sm text-gray-600 mb-3">
                        <span class="font-medium text-gray-800">××“×¨×™×š/×”:</span> ${instructorName}
                    </div>
                `
            }
            
            // Collect all contact methods
            const contactMethods = []
            
            // Center contact info
            if (centerPhone) {
                contactMethods.push({
                    type: 'center_phone',
                    label: '×˜×œ×¤×•×Ÿ ×”××¨×›×–',
                    value: centerPhone,
                    icon: 'ğŸ“'
                })
            }
            
            if (centerEmail) {
                contactMethods.push({
                    type: 'center_email', 
                    label: '××™××™×™×œ ×”××¨×›×–',
                    value: centerEmail,
                    icon: 'ğŸ“§'
                })
            }
            
            // Instructor contact info  
            if (instructorPhone) {
                contactMethods.push({
                    type: 'instructor_phone',
                    label: '×˜×œ×¤×•×Ÿ ×”××“×¨×™×š/×”',
                    value: instructorPhone,
                    icon: 'ğŸ“±'
                })
            }
            
            if (instructorEmail) {
                contactMethods.push({
                    type: 'instructor_email',
                    label: '××™××™×™×œ ×”××“×¨×™×š/×”', 
                    value: instructorEmail,
                    icon: 'âœ‰ï¸'
                })
            }
            
            // Website info
            if (centerWebsite) {
                contactMethods.push({
                    type: 'center_website',
                    label: '××ª×¨ ×”××¨×›×–',
                    value: centerWebsite,
                    icon: 'ğŸŒ'
                })
            }
            
            if (instructorWebsite) {
                contactMethods.push({
                    type: 'instructor_website',
                    label: '××ª×¨ ×”××“×¨×™×š/×”',
                    value: instructorWebsite, 
                    icon: 'ğŸŒ'
                })
            }
            
            // Display contact methods
            if (contactMethods.length > 0) {
                contactHtml += '<div class="space-y-2">'
                contactMethods.forEach(contact => {
                    contactHtml += `
                        <div class="text-sm text-gray-600 flex items-center">
                            <span class="ml-2">${contact.icon}</span>
                            <span class="font-medium ml-1">${contact.label}:</span>
                            <span>${contact.value}</span>
                        </div>
                    `
                })
                contactHtml += '</div>'
            }
            
            // WhatsApp buttons for phone numbers
            const phoneNumbers = [
                { phone: centerPhone, label: 'WhatsApp ×œ××¨×›×–' },
                { phone: instructorPhone, label: 'WhatsApp ×œ××“×¨×™×š/×”' }
            ].filter(item => item.phone)
            
            if (phoneNumbers.length > 0) {
                contactHtml += '<div class="mt-3 flex flex-wrap gap-2">'
                phoneNumbers.forEach(phoneItem => {
                    const cleanPhone = phoneItem.phone.replace(/[^\d]/g, '')
                    const whatsappLink = `https://wa.me/972${cleanPhone.startsWith('0') ? cleanPhone.substring(1) : cleanPhone}`
                    contactHtml += `
                        <a href="${whatsappLink}" target="_blank" class="inline-flex items-center contact-button bg-green-600 text-white text-xs px-2.5 py-1.5 rounded-md hover:bg-green-700">
                            <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/>
                            </svg>
                            ${phoneItem.label}
                        </a>
                    `
                })
                contactHtml += '</div>'
            }
            
            contactHtml += '</div>'
            return contactHtml
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...')
            
            // Mobile filter toggle
            const mobileToggle = document.getElementById('mobile-filter-toggle')
            const filterContainer = document.getElementById('filter-container')
            
            if (mobileToggle && filterContainer) {
                mobileToggle.addEventListener('click', function() {
                    filterContainer.classList.toggle('hidden')
                    filterContainer.classList.toggle('grid')
                })
            }

            // Filter change events
            const filters = [
                'neighborhood-filter',
                'center-filter', 
                'category-filter',
                'age-group-filter'
            ]
            
            filters.forEach(filterId => {
                const element = document.getElementById(filterId)
                if (element) {
                    element.addEventListener('change', applyFilters)
                }
            })

            // Search input
            const searchInput = document.getElementById('search-input')
            if (searchInput) {
                searchInput.addEventListener('input', debounce(applyFilters, 300))
            }

            // Neighborhood filter affects center filter
            const neighborhoodFilter = document.getElementById('neighborhood-filter')
            if (neighborhoodFilter) {
                neighborhoodFilter.addEventListener('change', updateCenterFilter)
            }

            // Hide filters on scroll (mobile)
            let lastScrollY = window.scrollY
            window.addEventListener('scroll', function() {
                if (window.innerWidth < 768) { // mobile only
                    if (window.scrollY > lastScrollY && window.scrollY > 100) {
                        if (filterContainer) {
                            filterContainer.classList.add('hidden')
                            filterContainer.classList.remove('grid')
                        }
                    }
                }
                lastScrollY = window.scrollY
            })
        }

        function updateCenterFilter() {
            const neighborhoodId = document.getElementById('neighborhood-filter')?.value
            const centerSelect = document.getElementById('center-filter')
            
            if (!centerSelect) return
            
            centerSelect.innerHTML = '<option value="">×›×œ ×”××¨×›×–×™×</option>'
            
            const filteredCenters = neighborhoodId 
                ? centers.filter(center => center.neighborhood_id == neighborhoodId)
                : centers
            
            filteredCenters.forEach(center => {
                const option = document.createElement('option')
                option.value = center.id
                option.textContent = center.name
                centerSelect.appendChild(option)
            })
            
            // Apply filters after updating center options
            applyFilters()
        }

        function applyFilters() {
            console.log('Applying filters...')
            
            const neighborhoodId = document.getElementById('neighborhood-filter')?.value
            const centerId = document.getElementById('center-filter')?.value
            const categoryId = document.getElementById('category-filter')?.value
            const ageGroupId = document.getElementById('age-group-filter')?.value
            const searchTerm = document.getElementById('search-input')?.value.toLowerCase().trim()

            // Filter activities
            let filtered = allActivities

            if (neighborhoodId) {
                filtered = filtered.filter(activity => 
                    activity.neighborhood_id == neighborhoodId
                )
            }

            if (centerId) {
                filtered = filtered.filter(activity => 
                    activity.center_id == centerId
                )
            }

            if (categoryId) {
                filtered = filtered.filter(activity => 
                    activity.category_id == categoryId
                )
            }

            // ×”×—×œ×£ ××ª ×”×—×œ×§ ×”×–×” ×‘×¤×•× ×§×¦×™×” applyFilters:

            if (ageGroupId) {
                // Get the selected age group info
                const selectedAgeGroup = ageGroups.find(ag => ag.id == ageGroupId)
                
                if (selectedAgeGroup) {
                    // Define age ranges for each group
                    const ageRanges = {
                        'kindergarten': { min: 3, max: 6 },
                        'elementary_low': { min: 6, max: 9 }, 
                        'elementary_high': { min: 9, max: 12 },
                        'middle_high': { min: 12, max: 18 },
                        'adults': { min: 18, max: 99 }
                    }
                    
                    const targetRange = ageRanges[selectedAgeGroup.group_key]
                    
                    if (targetRange) {
                        filtered = filtered.filter(activity => {
                            // Check if activity overlaps with target age range
                            const activityMin = activity.age_min
                            const activityMax = activity.age_max
                            
                            // If activity has age range, check for overlap
                            if (activityMin !== null && activityMax !== null) {
                                return activityMin <= targetRange.max && activityMax >= targetRange.min
                            }
                            
                            // If no age range, check by age_group_id
                            return activity.age_group_id == ageGroupId
                        })
                    } else {
                        // Fallback to exact age group match
                        filtered = filtered.filter(activity => 
                            activity.age_group_id == ageGroupId
                        )
                    }
                }
            }

            // ×‘××§×•× ×”×—×œ×§ ×”×–×” ×‘×ª×•×š applyFilters:
            if (searchTerm) {
                filtered = filtered.filter(activity => {
                    const searchFields = [
                        activity.class_name,
                        activity.description,
                        activity.instructor_name,
                        activity.center_name,
                        activity.category_name,
                        activity.instructor_phone,    // ×—×“×©
                        activity.instructor_email,    // ×—×“×©
                        activity.center_phone,        // ×—×“×©
                        activity.center_email         // ×—×“×©
                    ].map(field => (field || '').toLowerCase())
                    
                    return searchFields.some(field => field.includes(searchTerm))
                })
            }

            // Group and display filtered results
            const groupedFiltered = groupActivitiesByTemplate(filtered)
            displayActivities(groupedFiltered)
            updateResultsCount(groupedFiltered.length)

            console.log(`Filtered ${allActivities.length} activities to ${filtered.length} instances, ${groupedFiltered.length} unique classes`)
        }

        function updateResultsCount(count) {
            const element = document.getElementById('results-count')
            if (element) {
                if (count === 0) {
                    element.textContent = ''
                } else {
                    element.textContent = `× ××¦××• ${count} ×—×•×’×™×`
                }
            }
        }

        function debounce(func, wait) {
            let timeout
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout)
                    func(...args)
                }
                clearTimeout(timeout)
                timeout = setTimeout(later, wait)
            }
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loading-overlay')
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none'
            }
        }

        function showError() {
            const loadingOverlay = document.getElementById('loading-overlay')
            const errorMessage = document.getElementById('error-message')
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none'
            }
            
            if (errorMessage) {
                errorMessage.classList.remove('hidden')
            }
        }

        // Error handling for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason)
            showError()
        })

        // Error handling for JavaScript errors
        window.addEventListener('error', function(event) {
            console.error('JavaScript error:', event.error)
            showError()
        })
    </script>
</body>
</html>